Goè¯­è¨€åŸºç¡€ä¹‹Socketç½‘ç»œç¼–ç¨‹

ç°åœ¨çš„æˆ‘ä»¬å‡ ä¹æ¯å¤©éƒ½åœ¨ä½¿ç”¨äº’è”ç½‘ï¼Œä½†æ˜¯ä½ çŸ¥é“ç¨‹åºæ˜¯å¦‚æœé€šè¿‡ç½‘ç»œäº’ç›¸é€šä¿¡å—ï¼Ÿ

> æè¿°: ç›¸ä¿¡å¤§éƒ¨åˆ†äººé€šå¸¸æ˜¯ä¸€çŸ¥åŠè§£çš„ï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ğŸ‘¨â€ğŸ’»â€ï¼Œå¯¹äºç½‘ç»œæ¨¡å‹ä½ åº”è¯¥äº†è§£ï¼ŒçŸ¥é“ç½‘ç»œåˆ°åº•æ˜¯æ€ä¹ˆè¿›è¡Œé€šä¿¡çš„ï¼Œè¿›è¡Œå·¥ä½œçš„ï¼Œä¸ºä»€ä¹ˆæœåŠ¡å™¨èƒ½å¤Ÿæ¥æ”¶åˆ°è¯·æ±‚ï¼Œåšå‡ºå“åº”ã€‚è¿™é‡Œé¢çš„åŸç†åº”è¯¥æ˜¯æ¯ä¸ª Web ç¨‹åºå‘˜åº”è¯¥äº†è§£çš„ã€‚

æœ¬ç« æˆ‘ä»¬å°±ä¸€èµ·æ¥å­¦ä¹ ä¸‹Goè¯­è¨€ä¸­çš„ç½‘ç»œç¼–ç¨‹ï¼Œå…³äºç½‘ç»œç¼–ç¨‹å…¶å®æ˜¯ä¸€ä¸ªå¾ˆåºå¤§çš„é¢†åŸŸï¼Œæœ¬æ–‡åªæ˜¯ç®€å•çš„æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨netåŒ…è¿›è¡ŒTCPå’ŒUDPé€šä¿¡ã€‚

åŸºç¡€æ¦‚å¿µä»‹ç»

> æè¿°: äº’è”ç½‘çš„æ ¸å¿ƒæ˜¯ä¸€ç³»åˆ—åè®®ï¼Œæ€»ç§°ä¸ºäº’è”ç½‘åè®®(Internet Protocol Suite)ï¼Œæ­£æ˜¯è¿™ä¸€äº›åè®®è§„å®šäº†ç”µè„‘å¦‚ä½•è¿æ¥å’Œç»„ç½‘ï¼Œå¹¶é€šè¿‡å„ç§åè®®å®ç°ä¸åŒçš„åŠŸèƒ½, ä¸‹é¢ç®€å•ä»‹ç»ä¸€äº›åè®®æ¶‰åŠçš„åŸºç¡€çŸ¥è¯†æ¦‚å¿µã€‚

æ­¤å¤„ä¸å¾—ä¸è€ç”Ÿé‡è°ˆOSIä¸ƒå±‚ç½‘ç»œæ¨¡å‹ ï¼ŒOSIæ˜¯å›½é™…æ ‡å‡†åŒ–ç»„ç»‡ 1984 æå‡ºçš„æ¨¡å‹æ ‡å‡†ï¼Œç®€ç§° OSI(Open Systems Interconnection Model)ï¼Œä¸»è¦ç»Ÿä¸€æ ‡å‡†æ¥è§„èŒƒç½‘ç»œåè®®è®©å„ä¸ªç¡¬ä»¶å‚å•†å¯ä»¥ååŒå·¥ä½œï¼Œç›¸ä¿¡å¦‚æœä½ å­¦ä¹ è¿‡ç½‘ç»œå·¥ç¨‹æˆ–è€…æ“ä½œç³»ç»Ÿæ–¹é¢çš„è¯¾ç¨‹è‡³å°‘ä½ æ˜¯äº†è§£å®ƒçš„ã€‚æ¯ä¸€å±‚éƒ½æœ‰è‡ªå·±çš„åŠŸèƒ½ï¼Œå°±åƒå»ºç­‘ç‰©ä¸€æ ·ï¼Œæ¯ä¸€å±‚éƒ½é ä¸‹ä¸€å±‚æ”¯æŒï¼Œé€šå¸¸ç”¨æˆ·æ¥è§¦åˆ°çš„åªæ˜¯æœ€ä¸Šé¢çš„é‚£ä¸€å±‚ã€‚

![WeiyiGeek.OSIä¸ƒå±‚ç½‘ç»œä¸TCP/IPå››å±‚ç½‘ç»œæ¨¡å‹](https://i0.hdslb.com/bfs/article/6cb224ce36f3496d54218c62dbbb1f8fb821d9ca.png@942w_654h_progressive.png)


å¦‚ä¸Šå›¾æ‰€ç¤ºæŒ‰ç…§ä¸åŒçš„æ¨¡å‹åˆ’åˆ†ä¼šæœ‰ä¸ç”¨çš„åˆ†å±‚ï¼Œä½†æ˜¯ä¸è®ºæŒ‰ç…§ä»€ä¹ˆæ¨¡å‹å»åˆ’åˆ†ï¼Œè¶Šå¾€ä¸Šçš„å±‚è¶Šé è¿‘ç”¨æˆ·ï¼Œè¶Šå¾€ä¸‹çš„å±‚è¶Šé è¿‘ç¡¬ä»¶ï¼Œåœ¨è½¯ä»¶å¼€å‘ä¸­æˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„æ˜¯ä¸Šå›¾ä¸­å°†äº’è”ç½‘åˆ’åˆ†ä¸ºäº”ä¸ªåˆ†å±‚çš„æ¨¡å‹ï¼Œå³åº”ç”¨å±‚ã€ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ã€æ•°æ®é“¾è·¯å±‚ã€ç‰©ç†å±‚ã€‚

ä¸‹é¢ç®€å•ä»‹ç»å„å±‚: (å¦‚æœ‰å…´è¶£æƒ³æ·±å…¥å­¦ä¹ çš„å¯ä»¥è‡ªè¡ŒGoogle)

(1) ç‰©ç†å±‚ : å³é€šè¿‡æˆ‘ä»¬è®¡ç®—æœºæˆ–å…¶å®ƒè®¾å¤‡é€šè¿‡ç½‘ç»œç¡¬ä»¶ä¸å¤–ç•Œäº’è”ç½‘é€šä¿¡ï¼Œå®ƒä¸»è¦è§„å®šäº†ç½‘ç»œçš„ä¸€äº›ç”µæ°”ç‰¹æ€§ï¼Œä½œç”¨æ˜¯è´Ÿè´£ä¼ é€0å’Œ1çš„ç”µä¿¡å·(æ¯”ç‰¹æµ)ã€‚

> ä¾‹å¦‚ï¼š ä»¥å¤ªç½‘ã€æ— çº¿Lanã€PPPã€åŒç»çº¿ã€å…‰çº¤ã€æ— çº¿ã€‚

(2) æ•°æ®é“¾è·¯å±‚ : ç¡®å®šäº†ç‰©ç†å±‚ä¼ è¾“çš„0å’Œ1çš„åˆ†ç»„æ–¹å¼åŠä»£è¡¨çš„æ„ä¹‰, é€šè¿‡ä»¥å¤ªç½‘(Ethernet)çš„åè®®è§„å®šä¸€ç»„ç”µä¿¡å·æ„æˆä¸€ä¸ªæ•°æ®åŒ…ï¼Œå«åšå¸§(Frame)ã€‚

> æ¯ä¸€å¸§åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼šæ ‡å¤´(Head)å’Œæ•°æ®(Data)
> Head : åŒ…å«æ•°æ®åŒ…çš„ä¸€äº›è¯´æ˜é¡¹ï¼Œæ¯”å¦‚å‘é€è€…(MACåœ°å€)ã€æ¥å—è€…(MACåœ°å€)ã€æ•°æ®ç±»å‹ç­‰ç­‰ï¼›(å…¶é•¿åº¦å›ºå®šä¸º18å­—èŠ‚)
> Data : åˆ™æ˜¯æ•°æ®åŒ…çš„å…·ä½“å†…å®¹ã€‚(å…¶é•¿åº¦ï¼Œæœ€çŸ­ä¸º46å­—èŠ‚ï¼Œæœ€é•¿ä¸º1500å­—èŠ‚)
> Tips: å› æ­¤æ•´ä¸ªå¸§æœ€çŸ­ä¸º64å­—èŠ‚ï¼Œæœ€é•¿ä¸º1518å­—èŠ‚, æ‰€ä»¥å¦‚æœæ•°æ®å¾ˆé•¿å°±å¿…é¡»åˆ†å‰²æˆå¤šä¸ªå¸§è¿›è¡Œå‘é€ã€‚

(3) ç½‘ç»œå±‚ : ä½¿å¾—æˆ‘ä»¬èƒ½å¤ŸåŒºåˆ†ä¸åŒçš„è®¡ç®—æœºæ˜¯å¦å±äºåŒä¸€ä¸ªå­ç½‘ç»œ(å­ç½‘)ï¼Œè¯¥åœ°å€å°±å«åšç½‘ç»œåœ°å€(å³IPåœ°å€)ï¼Œæ­¤æ—¶æ¯å°è®¡ç®—æœºæœ‰äº†ä¸¤ç§åœ°å€ï¼Œä¸€ç§æ˜¯MACåœ°å€(ç¡¬ä»¶ç½‘å¡å”¯ä¸€æ ‡è¯†)ï¼Œå¦ä¸€ç§æ˜¯IPåœ°å€ã€‚

> IPåœ°å€: åˆ™æ˜¯ç½‘ç»œç®¡ç†å‘˜åˆ†é…çš„ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç¡®å®šè®¡ç®—æœºæ‰€åœ¨çš„å­ç½‘ç»œï¼ŒMACåœ°å€åˆ™å°†æ•°æ®åŒ…é€åˆ°è¯¥å­ç½‘ç»œä¸­çš„ç›®æ ‡ç½‘å¡ã€‚
> æ ¹æ®IPåè®®å‘é€çš„æ•°æ®å°±å«åšIPæ•°æ®åŒ…ï¼ŒIPæ•°æ®åŒ…ä¹Ÿåˆ†ä¸ºæ ‡å¤´å’Œæ•°æ®ä¸¤ä¸ªéƒ¨åˆ†ï¼š
> æ ‡å¤´éƒ¨åˆ†ä¸»è¦åŒ…æ‹¬ç‰ˆæœ¬ã€é•¿åº¦ã€IPåœ°å€ç­‰ä¿¡æ¯(é•¿åº¦ä¸º20åˆ°60å­—èŠ‚)
> æ•°æ®éƒ¨åˆ†åˆ™æ˜¯IPæ•°æ®åŒ…çš„å…·ä½“å†…å®¹ï¼Œæ•´ä¸ªæ•°æ®åŒ…çš„æ€»é•¿åº¦æœ€å¤§ä¸º65535å­—èŠ‚ã€‚

(4) ä¼ è¾“å±‚ : æœ‰äº†ä¸Šè¿°çš„MACåœ°å€å’ŒIPåœ°å€å¯ä»¥å°±å¯ä»¥åœ¨äº’è”ç½‘ä¸Šä»»æ„ä¸¤å°ä¸»æœºä¸Šå»ºç«‹é€šä¿¡ã€‚ä½†æ˜¯å¦‚æœæ˜¯è¦ä¸ä¸»æœºä¸ŠæŸä¸€ç¨‹åºè¿›è¡Œé€šä¿¡æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç«¯å£(Port)ï¼Œä»è€Œä¾¿å¯ä»¥è®©ä¸¤ä¸ªç¨‹åºé€šè¿‡ç½‘ç»œè¿›è¡Œæ”¶å‘æ•°æ®ã€‚

> IPå’Œç«¯å£æˆ‘ä»¬å°±èƒ½å®ç°å”¯ä¸€ç¡®å®šäº’è”ç½‘ä¸Šä¸€ä¸ªç¨‹åºï¼Œè¿›è€Œå®ç°ç½‘ç»œé—´çš„ç¨‹åºé€šä¿¡, æ­¤å¤–å¯ä»¥é€‰æ‹©å¸¸ç”¨çš„TCPæˆ–è€…UDPåè®®è¿›è¡Œé€šä¿¡ã€‚
> ç«¯å£: æ˜¯0åˆ°65535ä¹‹é—´çš„ä¸€ä¸ªæ•´æ•°ï¼Œæ­£å¥½16ä¸ªäºŒè¿›åˆ¶ä½ã€‚0åˆ°1023çš„ç«¯å£è¢«ç³»ç»Ÿå ç”¨ï¼Œç”¨æˆ·åªèƒ½é€‰ç”¨å¤§äº1023çš„ç«¯å£
> TCP (Transmission Control Protocol): é¢å‘è¿æ¥çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„ä¼ è¾“å±‚é€šä¿¡åè®®(ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹å››å±‚æŒ¥æ‰‹)ï¼Œç”±IETFçš„RFC 793å®šä¹‰ï¼ŒTCPæ•°æ®åŒ…æ²¡æœ‰é•¿åº¦é™åˆ¶ï¼Œç†è®ºä¸Šå¯ä»¥æ— é™é•¿ï¼Œä½†æ˜¯ä¸ºäº†ä¿è¯ç½‘ç»œçš„æ•ˆç‡ï¼Œé€šå¸¸TCPæ•°æ®åŒ…çš„é•¿åº¦ä¸ä¼šè¶…è¿‡IPæ•°æ®åŒ…çš„é•¿åº¦ï¼Œä»¥ç¡®ä¿å•ä¸ªTCPæ•°æ®åŒ…ä¸å¿…å†åˆ†å‰²ã€‚ (ä¸»è¦ç”¨äºå¯¹é€šä¿¡çš„ä¿¡æ¯æ¯”è¾ƒé‡è¦çš„åœºæ™¯)
> UDP (User Datagram Protocol) : ä¸ºåº”ç”¨ç¨‹åºæä¾›äº†ä¸€ç§æ— éœ€å»ºç«‹è¿æ¥å°±å¯ä»¥å‘é€å°è£…çš„ IP æ•°æ®åŒ…çš„æ–¹æ³•,æˆ‘ä»¬å¯ä»¥æŒç»­çš„å‘é€ä¿¡æ¯ä½†å¹¶ä¸å…³å¿ƒå…¶æ˜¯å¦æ­£å¸¸åˆ°è¾¾, ç”±IETFçš„ RFC 768 å®šä¹‰, å…¶æ•°æ®åŒ…éå¸¸ç®€å•ï¼Œâ€æ ‡å¤´â€éƒ¨åˆ†ä¸€å…±åªæœ‰8ä¸ªå­—èŠ‚ï¼Œæ€»é•¿åº¦ä¸è¶…è¿‡65,535å­—èŠ‚ï¼Œæ­£å¥½æ”¾è¿›ä¸€ä¸ªIPæ•°æ®åŒ…ã€‚(ä¸»è¦ç”¨äºè§†å±ç›´æ’­æµã€éå®æ—¶æ€§çš„æ§åˆ¶æŒ‡ä»¤å‘é€çš„åœºæ™¯)

(5) åº”ç”¨å±‚ : â€åº”ç”¨å±‚â€çš„ä½œç”¨å°±æ˜¯è§„å®šåº”ç”¨ç¨‹åºä½¿ç”¨çš„æ•°æ®æ ¼å¼ï¼Œç”±äºäº’è”ç½‘æ˜¯å¼€æ”¾æ¶æ„ï¼Œæ•°æ®æ¥æºäº”èŠ±å…«é—¨ï¼Œå¿…é¡»äº‹å…ˆè§„å®šå¥½é€šä¿¡çš„æ•°æ®æ ¼å¼ï¼Œå¦åˆ™æ¥æ”¶æ–¹æ ¹æœ¬æ— æ³•è·å¾—çœŸæ­£å‘é€çš„æ•°æ®å†…å®¹ã€‚

> ä¾‹å¦‚: æˆ‘ä»¬TCPåè®®ä¹‹ä¸Šå¸¸è§çš„Emailã€HTTPã€FTPç­‰åè®®ï¼Œè¿™äº›åè®®å°±ç»„æˆäº†äº’è”ç½‘åè®®çš„åº”ç”¨å±‚ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‘é€æ–¹çš„HTTPæ•°æ®ç»è¿‡äº’è”ç½‘çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¼šä¾æ¬¡æ·»åŠ å„å±‚åè®®çš„æ ‡å¤´ä¿¡æ¯ï¼Œæ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®åŒ…ä¹‹åå†ä¾æ¬¡æ ¹æ®åè®®è§£åŒ…å¾—åˆ°æ•°æ®ã€‚

![WeiyiGeek.ä¸€å¼ è§£é‡Šäº’è”ç½‘çš„ä¼ è¾“è¿‡ç¨‹çš„å›¾](https://i0.hdslb.com/bfs/article/c37c6278e244555f4f3c8906a383e838d49ec7af.png@942w_650h_progressive.png)


çŸ¥è¯†æ‰©å±•

> Q:é‚£ä¹ˆï¼Œå‘é€è€…å’Œæ¥å—è€…æ˜¯å¦‚ä½•æ ‡è¯†å‘¢ï¼Ÿ
> ç­”: ä»¥å¤ªç½‘è§„å®šï¼Œè¿å…¥ç½‘ç»œçš„æ‰€æœ‰è®¾å¤‡éƒ½å¿…é¡»å…·æœ‰ç½‘å¡æ¥å£ã€‚æ•°æ®åŒ…å¿…é¡»æ˜¯ä»ä¸€å—ç½‘å¡ï¼Œä¼ é€åˆ°å¦ä¸€å—ç½‘å¡ã€‚ç½‘å¡çš„åœ°å€ï¼Œå°±æ˜¯æ•°æ®åŒ…çš„å‘é€åœ°å€å’Œæ¥æ”¶åœ°å€ï¼Œè¿™å«åšMACåœ°å€ã€‚æ¯å—ç½‘å¡å‡ºå‚çš„æ—¶å€™ï¼Œéƒ½æœ‰ä¸€ä¸ªå…¨ä¸–ç•Œç‹¬ä¸€æ— äºŒçš„MACåœ°å€ï¼Œé•¿åº¦æ˜¯48ä¸ªäºŒè¿›åˆ¶ä½ï¼Œé€šå¸¸ç”¨12ä¸ªåå…­è¿›åˆ¶æ•°è¡¨ç¤ºä¾‹å¦‚00-FF-81-D5-15-F8ã€‚å‰6ä¸ªåå…­è¿›åˆ¶æ•°æ˜¯å‚å•†ç¼–å·ï¼Œå6ä¸ªæ˜¯è¯¥å‚å•†çš„ç½‘å¡æµæ°´å·, æ­¤æ—¶æœ‰äº†MACåœ°å€å°±å¯ä»¥å®šä½ç½‘å¡å’Œæ•°æ®åŒ…çš„è·¯å¾„äº†ã€‚

> Q: æœ‰äº†MACåœ°å€ä¹‹åï¼Œå¦‚ä½•æŠŠæ•°æ®å‡†ç¡®çš„å‘é€ç»™æ¥æ”¶æ–¹å‘¢ï¼Ÿ
> æè¿°: é¦–å…ˆé€šè¿‡ARPåè®®æ¥è·å–æ¥å—æ–¹çš„MACåœ°å€, ç„¶åé€šè¿‡å¹¿æ’­(broadcasting)çš„æ–¹å¼ï¼Œå‘æœ¬ç½‘ç»œå†…æ‰€æœ‰è®¡ç®—æœºéƒ½å‘é€ï¼Œè®©æ¯å°è®¡ç®—æœºè¯»å–è¿™ä¸ªåŒ…çš„æ ‡å¤´ï¼Œæ‰¾åˆ°æ¥æ”¶æ–¹çš„MACåœ°å€ï¼Œç„¶åä¸è‡ªèº«çš„MACåœ°å€ç›¸æ¯”è¾ƒï¼Œå¦‚æœä¸¤è€…ç›¸åŒå°±æ¥å—è¿™ä¸ªåŒ…ï¼Œåšè¿›ä¸€æ­¥å¤„ç†ï¼Œå¦åˆ™å°±ä¸¢å¼ƒè¿™ä¸ªåŒ…ã€‚

> Q: ç½‘ç»œåœ°å€çš„åè®®?
> æè¿°: è§„å®šç½‘ç»œåœ°å€çš„åè®®å«åšIPåè®®,ç›®å‰ï¼Œå¹¿æ³›é‡‡ç”¨çš„æ˜¯IPåè®®ç¬¬å››ç‰ˆï¼Œç®€ç§°IPv4ã€‚IPv4è¿™ä¸ªç‰ˆæœ¬è§„å®šï¼Œç½‘ç»œåœ°å€ç”±32ä¸ªäºŒè¿›åˆ¶ä½ç»„æˆï¼Œæˆ‘ä»¬é€šå¸¸ä¹ æƒ¯ç”¨åˆ†æˆå››æ®µçš„åè¿›åˆ¶æ•°è¡¨ç¤ºIPåœ°å€ï¼Œä»0.0.0.0~255.255.255.255ï¼Œå½“ç„¶é‡Œé¢åŒ…å«ä¸‰ä¸ªç§æœ‰ç½‘æ®µï¼Œä»¥åŠä¿ç•™çš„ç½‘æ®µï¼Œæ­¤å¤„ä¸ç»†è®²çŸ¥é“å³å¯ã€‚



Socket åŸºç¡€ä»‹ç»

å…¶å®å­¦ä¹ å…¶å®ƒå¼€å‘è¯­è¨€ä½ å°†ä¼šå‘ç°, åŸºæœ¬é«˜çº§è¯­è¨€ä¸­éƒ½æœ‰ä¸“é—¨è¿›è¡Œç½‘ç»œé€šä¿¡çš„åŒ…æ¥æä¾›ä¸¤ä¸ªç¨‹åºçš„ç½‘ç»œé€šä¿¡, é€šå¸¸é’ˆå¯¹ç¨‹åºç½‘ç»œé€šä¿¡çš„å¼€å‘éƒ½æè¿°ä¸ºSocketç¼–ç¨‹ã€‚

> Q: ä»€ä¹ˆæ˜¯Socketç¼–ç¨‹?
> æè¿°: Socket(ä¹Ÿç§°ä½œâ€å¥—æ¥å­—â€)æ˜¯BSD UNIXçš„è¿›ç¨‹é€šä¿¡æœºåˆ¶ï¼Œç”¨äºæè¿°IPåœ°å€å’Œç«¯å£æ˜¯ä¸€ä¸ªé€šä¿¡é“¾çš„å¥æŸ„,Socketå¯ç†è§£ä¸ºTCP/IPç½‘ç»œçš„APIï¼Œå®ƒå®šä¹‰äº†è®¸å¤šå‡½æ•°æˆ–ä¾‹ç¨‹ï¼Œç¨‹åºå‘˜å¯ä»¥ç”¨å®ƒä»¬æ¥å¼€å‘TCP/IPç½‘ç»œä¸Šçš„åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬è®¡ç®—æœºè¿è¡Œçš„åº”ç”¨ç¨‹åºé€šå¸¸é€šè¿‡"å¥—æ¥å­—"å‘ç½‘ç»œå‘å‡ºè¯·æ±‚æˆ–è€…åº”ç­”ç½‘ç»œè¯·æ±‚ã€‚

Socket æ˜¯åº”ç”¨å±‚ä¸ä¼ è¾“å±‚(TCP/IPåè®®æ—)é€šä¿¡çš„ä¸­é—´è½¯ä»¶æŠ½è±¡å±‚ï¼Œåœ¨è®¾è®¡æ¨¡å¼ä¸­Socketå…¶å®å°±æ˜¯ä¸€ä¸ªé—¨é¢æ¨¡å¼ï¼Œå®ƒæŠŠå¤æ‚çš„TCP/IPåè®®æ—éšè—åœ¨Socketåé¢ï¼Œå¯¹ç”¨æˆ·æ¥è¯´åªéœ€è¦è°ƒç”¨Socketè§„å®šçš„ç›¸å…³å‡½æ•°ï¼Œè®©Socketå»ç»„ç»‡ç¬¦åˆæŒ‡å®šçš„åè®®æ•°æ®ç„¶åè¿›è¡Œé€šä¿¡ã€‚

![WeiyiGeek.Socketå›¾è§£](https://i0.hdslb.com/bfs/article/1feb05ddbbc8b3e3f7fcc78f48e3cafa07998c1f.png@942w_672h_progressive.png)


Goå®ç°C/Sç«¯TCPé€šä¿¡

> æè¿°: TCP/IP(Transmission Control Protocol/Internet Protocol)å³ä¼ è¾“æ§åˆ¶åè®®/ç½‘é—´åè®®ï¼Œæ˜¯ä¸€ç§é¢å‘è¿æ¥(è¿æ¥å¯¼å‘)çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„ä¼ è¾“å±‚(Transport layer)é€šä¿¡åè®®ï¼Œå› ä¸ºæ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œæ•°æ®åƒæ°´æµä¸€æ ·ä¼ è¾“ï¼Œä½†å®ƒä¼šå­˜åœ¨é»åŒ…é—®é¢˜(å°†ä¼šåœ¨åç»­æ¼”ç¤ºè§£å†³æ–¹æ¡ˆ)ã€‚

1) TCP æœåŠ¡ç«¯

> æè¿°: é€šå¸¸ä¸€ä¸ªTCPæœåŠ¡ç«¯å¯ä»¥åŒæ—¶è¿æ¥å¾ˆå¤šä¸ªå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚ä¸–ç•Œå„åœ°çš„ç”¨æˆ·ä½¿ç”¨è‡ªå·±ç”µè„‘ä¸Šçš„æµè§ˆå™¨è®¿é—®æ·˜å®ç½‘ã€äº¬ä¸œå•†åŸã€‚

ç”±äºGoè¯­è¨€ä¸­åˆ›å»ºå¤šä¸ªgoroutineå®ç°å¹¶å‘éå¸¸æ–¹ä¾¿å’Œé«˜æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¯å»ºç«‹ä¸€æ¬¡é“¾æ¥å°±åˆ›å»ºä¸€ä¸ªgoroutineå»å¤„ç†ã€‚

TCPæœåŠ¡ç«¯ç¨‹åºå¸¸è§„æµç¨‹ï¼š
1.è®¾ç½®ç›‘å¬ç½‘ç»œåœ°å€ä¸ç«¯å£
2.æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹é“¾æ¥
3.åˆ›å»ºgoroutineå¤„ç†é“¾æ¥

åœ¨Goè¯­è¨€ä¸­çš„å¯ä»¥é‡‡ç”¨netåŒ…æ¥å®ç°çš„TCPæœåŠ¡ç«¯çš„åˆ›å»º,ä¸‹è¿°ç½—åˆ—å‡ºnetåŒ…ä¸­ä½¿ç”¨çš„ç›¸å…³æ–¹æ³•åŸå‹:

â€‹	func net.Listen(network string, address string) (net.Listener, error) : æŒ‡å®šé€šä¿¡åè®®ç±»å‹ç‰ˆæœ¬ã€æœ¬åœ°ç½‘ç»œåœ°å€å’Œé€šä¿¡ç«¯å£è¿›è¡Œç›‘å¬,æ³¨æ„ networkå‚æ•°å€¼å¿…é¡»æ˜¯â€œtcpâ€ã€â€œtcp4â€ã€â€œtcp6â€ã€â€œunixâ€æˆ–â€œunixpacketâ€ä¹‹ä¸€ã€‚
â€‹	func (net.Listener).Accept() (net.Conn, error) : ç­‰å¾…Listenerå¯¹è±¡å¹¶è¿”å›åˆ°ä¾¦å¬å™¨çš„ä¸‹ä¸€ä¸ªè¿æ¥ã€‚
â€‹	func (net.Conn).Read(b []byte) (n int, err error) : ä»æœåŠ¡ç«¯æˆ–è€…å®¢æˆ·ç«¯è¿æ¥ä¸­è¯»å–æ•°æ®ã€‚


2) TCP å®¢æˆ·ç«¯

TCPå®¢æˆ·ç«¯è¿›è¡ŒTCPé€šä¿¡çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š
1.ä¸æœåŠ¡ç«¯çš„å»ºç«‹é“¾æ¥
2.ä¸æœåŠ¡ç«¯è¿›è¡Œæ•°æ®æ”¶å‘
3.å…³é—­ä¸æœåŠ¡ç«¯çš„é“¾æ¥

ä¸‹è¿°ç½—åˆ—å‡ºnetåŒ…ä¸­Tcpå®¢æˆ·ç«¯åˆ›å»ºä½¿ç”¨çš„ç›¸å…³æ–¹æ³•åŸå‹:

â€‹	func net.Dial(network string, address string) (net.Conn, error) : å®¢æˆ·ç«¯è¿æ¥åˆ°æŒ‡å®šç½‘ç»œä¸Šçš„åœ°å€, åŒæ · networks å‚æ•°å¯é€‰å€¼å¦‚ä¸‹"tcp", "tcp4" (IPv4-only), "tcp6" (IPv6-only), "udp", "udp4" (IPv4-only), "udp6" (IPv6-only), "ip", "ip4" (IPv4-only), "ip6" (IPv6-only), "unix", "unixgram" and "unixpacket".
â€‹	func (net.Conn).Write(b []byte) (n int, err error) : å†™å…¥å°†æ•°æ®å†™å…¥è¿æ¥å³å‘é€ç»™è¿æ¥çš„ç½‘ç»œå¯¹è±¡ï¼Œå¹¶è¿”å›å‘é€çš„å­—èŠ‚æ•°ã€‚ï¼ˆæ³¨æ„ä¸­æ–‡å­—ç¬¦å 3å­—èŠ‚ï¼‰
â€‹	func (net.Conn).LocalAddr() net.Addr : è·å–æœ¬åœ°å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯çš„ç½‘ç»œåœ°å€ä¿¡æ¯ã€‚

ç®€å•ç¤ºä¾‹1:TCP Serverç«¯ä¸Clientç«¯ä¸€æ¬¡é€šä¿¡ã€‚

æœåŠ¡ç«¯: Server.go

```go
func main() {
	// 1.è®¾ç½®æœåŠ¡ç«¯ç›‘å¬ç«¯å£
	address := "10.20.172.108:22022"
	listener, err := net.Listen("tcp", address)
	if err != nil {
		fmt.Printf("Start Tcp Server on %v Failed!\nerrï¼š%v\n", address, err)
		return
	} else {
		fmt.Printf("Server Listen : %v\n", address)
	}

	// 2.ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹è¿æ¥
	conn, err := listener.Accept()
	if err != nil {
		fmt.Printf("Accept failed,err: %v\n", err)
		return
	}
	defer conn.Close() // ç¨‹åºç»“æŸæ—¶,å…³é—­ä¸å®¢æˆ·ç«¯æ‰“å¼€çš„TCPè¿æ¥é€šé“
	
	// 3.ä¸å®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡(è¯»å–å®¢æˆ·ç«¯æ³•è¿‡æ¥çš„ä¿¡æ¯)
	var msg [1024]byte
	n, err := conn.Read(msg[:]) // æ³¨æ„è¯»å–çš„ç±»å‹æ˜¯byteçš„slice
	if err != nil {
		fmt.Printf("Read from Client conn failed, err:%v\n", err)
		return
	}
	
	// 4.æ‰“å°å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯,æ³¨æ„æ­¤éœ€è¦å°†[]byteç±»å‹çš„åˆ‡ç‰‡,è½¬ä¸ºå­—ç¬¦ä¸²ç±»å‹è¿›è¡Œè¾“å‡º.
	fmt.Println(string(msg[:n]))

}
```


å®¢æˆ·ç«¯: Client.go

```go
func main() {
	// 1.ä¸Serverç«¯å»ºç«‹TCPé€šä¿¡é“¾æ¥
	address := "10.20.172.108:22022"
	conn, err := net.Dial("tcp", address)
	if err != nil {
		fmt.Printf("Connect Server failed!\nerr:%v\n", err)
		return
	}

	// 2.å‘é€å­—ç¬¦ä¸²æ•°æ®åˆ°Serverç«¯
	sendMsg := "Hello World! Server, I'm client"
	conn.Write([]byte(sendMsg))
	
	// 3.å…³é—­å»ºç«‹çš„TCPé€šä¿¡é“¾æ¥
	defer conn.Close()
}
```

å°†ä¸Šé¢çš„ä»£ç ä¿å­˜ä¹‹ååˆ†åˆ«ç¼–è¯‘æˆserverå’Œclientå¯æ‰§è¡Œæ–‡ä»¶,å…·ä½“æ“ä½œå¦‚ä¸‹:

```sh
âœ  Server go build
âœ  Server ./Server
Server Listen : 10.20.172.108:22022

âœ  Client go build
âœ  Client ./Client
```

è¿›é˜¶ç¤ºä¾‹2: TCP Serverç«¯ä¸å¤šä¸ªClientç«¯æŒç»­é€šä¿¡ã€‚
æœåŠ¡ç«¯ Server.go 

```go
package main
import (
	"bufio"
	"fmt"
	"io"
	"net"
)
func SendReceiveProccess(conn net.Conn) {
	// 3.ä¸å®¢æˆ·ç«¯è¿›è¡Œæ¶ˆæ¯é€šä¿¡(å¾ªç¯è¯»å–å®¢æˆ·ç«¯æ³•è¿‡æ¥çš„ä¿¡æ¯)
	defer conn.Close() // å…³é—­å½“å‰é“¾æ¥é€šä¿¡å¯¹è±¡
	reader := bufio.NewReader(conn)
	var msg [1024]byte // æ¯æ¬¡è¯»å–1024B
	for {
		n, err := reader.Read(msg[:]) // æ³¨æ„è¯»å–çš„ç±»å‹æ˜¯byteçš„slice
		// æœ«å°¾æ ‡è¯†
		if err == io.EOF {
			fmt.Printf("Close conn %v\n", conn.RemoteAddr())
			break
		}
		// å¼‚å¸¸æ—¶break
		if err != nil {
			fmt.Printf("Read from Client conn failed, Close conn %v\n", conn.RemoteAddr())
			break
		}
		fmt.Println(conn.RemoteAddr(), "->", string(msg[:n]))

		// å°†å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯åˆè½¬å‘ç»™å®¢æˆ·ç«¯(è¿”å›å†™å…¥çš„å­—èŠ‚æ•°)
		_, err = conn.Write([]byte(msg[:n]))
		if err != nil {
			fmt.Printf("Send failed, Close Client conn %v\n", conn.RemoteAddr())
			break
		}
	}

}

func main() {
	// 1.è®¾ç½®ç›‘å¬ç«¯å£
	address := "10.20.172.108:22022"
	listener, err := net.Listen("tcp", address)
	if err != nil {
		fmt.Printf("Start Tcp Server on %v Failed!\nerrï¼š%v\n", address, err)
		return
	} else {
		fmt.Printf("Server Listen %v Start......\n", address)
	}
	defer listener.Close() // å…³é—­æœåŠ¡ç«¯ç›‘å¬

	// 2.ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹è¿æ¥
	for {
		conn, err := listener.Accept()
		if err != nil {
			fmt.Printf("Accept failed,err: %v\n", err)
			return
		}
	// ä¸åŒçš„å®¢æˆ·ç«¯åˆ©ç”¨Goroutineåˆ†é…ä¸åŒçš„çº¿ç¨‹è¿›è¡Œå“åº”ã€‚
		go SendReceiveProccess(conn)
	}

}
```


å®¢æˆ·ç«¯ Client.go

```go
package main

import (
	"bufio"
	"fmt"
	"net"
	"os"
	"strings"
)

func main() {
	// 1.ä¸Serverç«¯å»ºç«‹TCPé“¾æ¥
	address := "10.20.172.108:22022"
	conn, err := net.Dial("tcp", address)
	if err != nil {
		fmt.Printf("Connect Server failed! \n [err]: %v\n", err)
		return
	} else {
		fmt.Printf("Connect Server %v successful!\n", address)
	}
	// é€€å‡ºé€šä¿¡è¿æ¥
	defer conn.Close()

	// 2.å‘é€åˆå§‹è¿æ¥ä¿¡æ¯åˆ°Serverç«¯
	sendMsg := fmt.Sprintf("Hello Server, I'm  %v client.", conn.LocalAddr())
	inputReader := bufio.NewReader(os.Stdin) // å¤ä¹ ç‚¹
	conn.Write([]byte(sendMsg))
	
	// 3.å¾ªç¯ä»æœåŠ¡ç«¯æ¥æ”¶ä»¥åŠä»ç»ˆç«¯è¾“å…¥å‘é€ä¿¡æ¯åˆ°æœåŠ¡ç«¯
	for {
		// æœåŠ¡ç«¯å›å¤çš„ä¿¡æ¯
		reply := [1024]byte{}
		n, err := conn.Read(reply[:])
		if err != nil {
			fmt.Println("recv failed, err:", err)
			return
		}
		fmt.Printf("Server > %v\n", string(reply[:n]))
	
		// å®¢æˆ·ç«¯è¾“å…¥å­—ç¬¦ä¸²ä¿¡æ¯
		fmt.Printf("è¯·è¾“å…¥æ¶ˆæ¯:")
		sendMsg, _ = inputReader.ReadString('\n') // å¤ä¹ ç‚¹ (ä»¥\næˆªè‡³è¯»å–)
		sendMsg = strings.TrimSpace(sendMsg)      // å¤ä¹ ç‚¹ å¤„ç†è¾“å…¥å­—ç¬¦ä¸²çš„å‰åç©ºæ ¼
		sendMsg = strings.Trim(sendMsg, "\n")     // å¤ä¹ ç‚¹ å¤„ç†è¾“å…¥å­—ç¬¦ä¸²çš„æœ€åçš„æ¢è¡Œç¬¦
	
		// ä½†å®¢æˆ·ç«¯è¾“å…¥quitåˆ™é€€å‡ºä¸æœåŠ¡ç«¯å»ºç«‹çš„TCPé€šä¿¡è¿æ¥.
		if strings.ToUpper(sendMsg) == "QUIT" {
			fmt.Printf("exit conn.......")
			break
		}
	
		// å‘é€å·²ç»å¤„ç†è¿‡åçš„ä¿¡æ¯åˆ°æœåŠ¡ç«¯
		_, err = conn.Write([]byte(sendMsg))
		if err != nil {
			return
		}
	}

}
```


Server.goä¸Client.go çš„ç¼–è¯‘&è¿è¡Œ&æ‰§è¡Œç»“æœ:

```sh
go build && ./Server
go build && ./Client
```

Goå®ç°C/Sç«¯UDPé€šä¿¡

> æè¿°: UDPåè®®ï¼ˆUser Datagram Protocolï¼‰ä¸­æ–‡åç§°æ˜¯ç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼Œæ˜¯OSIï¼ˆOpen System Interconnectionï¼Œå¼€æ”¾å¼ç³»ç»Ÿäº’è”ï¼‰å‚è€ƒæ¨¡å‹ä¸­ä¸€ç§æ— è¿æ¥çš„ä¼ è¾“å±‚åè®®ï¼Œä¸éœ€è¦å»ºç«‹è¿æ¥å°±èƒ½ç›´æ¥è¿›è¡Œæ•°æ®å‘é€å’Œæ¥æ”¶ï¼Œå±äºä¸å¯é çš„ã€æ²¡æœ‰æ—¶åºçš„é€šä¿¡ï¼Œä½†æ˜¯UDPåè®®çš„å®æ—¶æ€§æ¯”è¾ƒå¥½ï¼Œé€šå¸¸ç”¨äºè§†é¢‘ç›´æ’­ç›¸å…³é¢†åŸŸã€‚

Tips : UDP é€šä¿¡ç›¸æ¯”è¾ƒäº TCP é€šä¿¡ä½¿ç”¨ç®€å•, ä¸‹è¿°æˆ‘å°†UDPæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å®ç°çš„ç›¸å…³æ–¹æ³•åŸå‹è¿›è¡Œå±•ç¤ºã€‚

â€‹	func net.ListenUDP(network string, laddr *net.UDPAddr) (*net.UDPConn, error): è®¾ç½®ç›‘å¬UDPç›¸å…³çš„ç½‘ç»œåœ°å€ä¸ç«¯å£ä¿¡æ¯ã€ç½‘ç»œå¿…é¡»æ˜¯UDPç½‘ç»œåç§°ã€‚
â€‹	func (\*net.UDPConn).ReadFromUDP(b []byte) (int, \*net.UDPAddr, error): æ¥æ”¶connå¯¹è±¡é‡Œå‘é€çš„ä¿¡æ¯, ReadFromUDPä¸ReadFromç±»ä¼¼ï¼Œä½†è¿”å›ä¸€ä¸ªUDPADDã€‚
â€‹	func (\*net.UDPConn).WriteToUDP(b []byte, addr \*net.UDPAddr) (int, error): å‘é€ä¿¡æ¯åˆ°connå¯¹è±¡é‡Œ, WriteToUDPçš„è¡Œä¸ºç±»ä¼¼äºWriteToï¼Œä½†ä½¿ç”¨UDPADDã€‚
func net.DialUDP(network string, laddr *net.UDPAddr, raddr *net.UDPAddr) (*net.UDPConn, error) : ä½œç”¨äºä¸UDPæœåŠ¡ç«¯å»ºç«‹è¿æ¥, DialUDPçš„ä½œç”¨ç±»ä¼¼äºUDPç½‘ç»œçš„æ‹¨å·ã€‚

è¿›é˜¶ç¤ºä¾‹1.å®ç°UDPæœåŠ¡ç«¯ä¸å¤šå®¢æˆ·ç«¯è¿›è¡Œè¿æ¥é€šä¿¡!

Server.go

```go
package main
import (
	"fmt"
	"net"
	"strings"
	"time"
)
func main() {
	// 1.æœåŠ¡ç«¯å¼€å¯ç›‘å¬ UDP é€šä¿¡çš„ç›¸å…³è®¾ç½®
	server_ip := [4]byte{10, 20, 172, 108}
	server_port := 30000
	conn, err := net.ListenUDP("udp", &net.UDPAddr{
		IP:   net.IPv4(server_ip[0], server_ip[1], server_ip[2], server_ip[3]),
		Port: server_port,
	})

	if err != nil {
		fmt.Printf("Listen UDP Server (%v:%v) Failed, err: %v\n", server_ip, server_port, err)
		return
	} else {
		fmt.Printf("[%v] Listening UDP Server %v:%v is successful!\n", time.Now().Format("2006-01-02 15:04:05"), server_ip, server_port)
	}
	// ç¨‹åºç»“æŸæ—¶å…³é—­connèµ„æº
	defer conn.Close()
	
	// 2.å¾ªç¯æ¥æ”¶å’Œå“åº”æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œéå¸¸ä¸»è¦æ­¤å¤„ä¸éœ€è¦å»ºç«‹è¿æ¥ï¼Œç›´æ¥æ”¶å‘æ•°æ®ã€‚
	for {
		// è·å¾—å®¢æˆ·ç«¯é€šä¿¡å¯¹è±¡ä»¥åŠè¿”å›è¯»å–çš„å­—èŠ‚æ•°
		var recvMsg [1024]byte
		count, addr, err := conn.ReadFromUDP(recvMsg[:]) // æ¥æ”¶æ•°æ®
		if err != nil {
			fmt.Println("Read from UDP Client failed. Err:", err)
			return
		}
		// æ‰“å°å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯åˆ°ç»ˆç«¯
		fmt.Printf("[%v] %v - %v\n", time.Now().Format("2006-01-02 15:04:05"), addr.String(), string(recvMsg[:count-1]))
	
		// å¹¶å°†æ¥æ”¶åˆ°çš„ä¿¡æ¯æ›´æ”¹ä¸ºå¤§å†™ï¼Œå†è¿”è¿˜ç»™Clientã€‚
		reply := strings.ToUpper(string(recvMsg[:count]))
		conn.WriteToUDP([]byte(reply), addr) // å‘é€æ•°æ®
	}

}
```


Client.go

```go
package main
import (
	"bufio"
	"fmt"
	"net"
	"os"
	"strings"
	"time"
)
func main() {
	// (1) ä¸æœåŠ¡ç«¯å»ºç«‹UDPé€šä¿¡é“¾æ¥
	server_ip := [4]byte{10, 20, 172, 108}
	server_port := 30000
	socket, err := net.DialUDP("udp", nil, &net.UDPAddr{
		IP:   net.IPv4(server_ip[0], server_ip[1], server_ip[2], server_ip[3]),
		Port: server_port,
	})
	if err != nil {
		fmt.Printf("Connect UDP Server (%v:%v) Failed! err: %v\n", server_ip, server_port, err)
		return
	} else {
		fmt.Printf("[%v] - Connect UDP Server %v:%v successful!\n", time.Now().Format("2006-01-02 15:04:05"), server_ip, server_port)
	}
	// åŒæ ·å…³é—­å»ºç«‹çš„é€šä¿¡è¿æ¥
	defer socket.Close()

	// (2) å‘é€ä¸æ¥æ”¶æœåŠ¡ç«¯è¿”å›çš„ä¿¡æ¯
	var reply [1024]byte
	inputData := bufio.NewReader(os.Stdin)
	for {
		// ç»ˆç«¯æ¥æ”¶è¾“å…¥è¦å‘é€çš„ç»™æœåŠ¡ç«¯çš„å†…å®¹
		fmt.Print("<- è¯·è¾“å…¥å°†è¦å‘é€çš„å†…å®¹:")
		sendMsg, _ := inputData.ReadString('\n')
		sendMsg = strings.TrimSpace(sendMsg) // å–æ¶ˆå­—ç¬¦ä¸²å‰åçš„ç©ºæ ¼
		socket.Write([]byte(sendMsg))        // å‘é€æ•°æ®
		if err != nil {
			fmt.Printf("å‘é€æ•°æ®å¤±è´¥ï¼Œerr: %v\n", err)
			return
		}
		// æ¥æ”¶æ¥è‡ªæœåŠ¡ç«¯çš„åé¦ˆçš„å†…å®¹
		count, _, err := socket.ReadFromUDP(reply[:]) // æ¥æ”¶æ•°æ®
		if err != nil {
			fmt.Printf("æ¥æ”¶æ•°æ®å¤±è´¥, err: %v\n", err)
			return
		}
		fmt.Printf("Server -> [%v Bytes] %v \n", count, string(reply[:count]))
	}

}
```


æ‰§è¡Œç»“æœ:

![WeiyiGeek.å®ç°UDPæœåŠ¡ç«¯ä¸å¤šå®¢æˆ·ç«¯è¿›è¡Œè¿æ¥é€šä¿¡!](https://i0.hdslb.com/bfs/article/e6167e40f4d1877f01bd3de5eebb40382821cc93.png@942w_236h_progressive.png)


5.è¯¾å¤–çŸ¥è¯†æ‰©å±•

1) TCP é»åŒ…

åœ¨è®²è§£TCPé»åŒ…å‰æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹TCPé»åŒ…ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜?

é»åŒ…ç¤ºä¾‹æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
func process(conn net.Conn) {
	defer conn.Close()
	reader := bufio.NewReader(conn)
	var buf [1024]byte
	for {
		n, err := reader.Read(buf[:])
		if err == io.EOF {
			break
		}
		if err != nil {
			fmt.Println("read from client failed, err:", err)
			break
		}
		recvStr := string(buf[:n])
		fmt.Println("æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š", recvStr)
	}
}

func main() {
	listen, err := net.Listen("tcp", "127.0.0.1:30000")
	if err != nil {
		fmt.Println("listen failed, err:", err)
		return
	}
	defer listen.Close()
	for {
		conn, err := listen.Accept()
		if err != nil {
			fmt.Println("accept failed, err:", err)
			continue
		}
		go process(conn)
	}
}
```

é»åŒ…ç¤ºä¾‹å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹:

```go
func main() {
	conn, err := net.Dial("tcp", "127.0.0.1:30000")
	if err != nil {
		fmt.Println("dial failed, err", err)
		return
	}
	defer conn.Close()
	for i := 0; i < 20; i++ {
		msg := `Hello, Hello. How are you?`
		conn.Write([]byte(msg))
	}
}
```


å°†ä¸Šé¢çš„ä»£ç ä¿å­˜ååˆ†åˆ«ç¼–è¯‘, å…ˆå¯åŠ¨æœåŠ¡ç«¯ç„¶åå†å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```sh
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?
```


ä»å®¢æˆ·ç«¯ç¤ºä¾‹ä»£ç ä¸­å¯ä»¥çœ‹è§å®¢æˆ·ç«¯åˆ†20æ¬¡å‘é€çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨æœåŠ¡ç«¯å¹¶æ²¡æœ‰æˆåŠŸçš„è¾“å‡º20æ¬¡ï¼Œè€Œæ˜¯å¤šæ¡æ•°æ®â€œç²˜â€åˆ°äº†ä¸€èµ·ï¼Œè¿™å°±æ˜¯TCPé»åŒ…å¸¦æ¥çš„é—®é¢˜ã€‚



> Q: æ­¤æ—¶å¯èƒ½ä¼šé—®ä¸ºä»€ä¹ˆä¼šå‡ºç°ç²˜åŒ…?
>
> ç­”ï¼šä¸»è¦åŸå› å°±æ˜¯tcpæ•°æ®ä¼ é€’æ¨¡å¼æ˜¯æµæ¨¡å¼ï¼Œåœ¨ä¿æŒé•¿è¿æ¥çš„æ—¶å€™å¯ä»¥è¿›è¡Œå¤šæ¬¡çš„æ”¶å’Œå‘, è€ŒTCPé»åŒ…å¯ä»¥å‘ç”Ÿåœ¨åœ¨å‘é€ç«¯ä¹Ÿå¯å‘ç”Ÿåœ¨æ¥æ”¶ç«¯, ä¸»è¦æ˜¯ç”±äºNagleç®—æ³•å¯¼è‡´çš„ã€‚
> Nagleç®—æ³•æ˜¯ä¸€ç§æ”¹å–„ç½‘ç»œä¼ è¾“æ•ˆç‡çš„ç®—æ³•ï¼Œ é€šå¸¸åœ¨å‘é€ç«¯ç”±äºNagleç®—æ³•å¯¼è‡´çš„é»åŒ…é—®é¢˜,è€Œæ¥æ”¶ç«¯æ¥æ”¶ä¸åŠæ—¶ä¹Ÿä¼šé€ æˆçš„æ¥æ”¶ç«¯ç²˜åŒ…ã€‚
> å‘é€ç«¯: ç®€å•æ¥è¯´å°±æ˜¯å½“æˆ‘ä»¬æäº¤ä¸€æ®µæ•°æ®ç»™TCPå‘é€æ—¶ï¼ŒTCPå¹¶ä¸ç«‹åˆ»å‘é€æ­¤æ®µæ•°æ®ï¼Œè€Œæ˜¯ç­‰å¾…ä¸€å°æ®µæ—¶é—´çœ‹çœ‹åœ¨ç­‰å¾…æœŸé—´æ˜¯å¦è¿˜æœ‰è¦å‘é€çš„æ•°æ®ï¼Œè‹¥æœ‰åˆ™ä¼šä¸€æ¬¡æŠŠè¿™ä¸¤æ®µæ•°æ®å‘é€å‡ºå»ï¼Œæ‰€ä»¥è¯´Nagleç®—æ³•ç‰¹æ€§å…¶å¹¶ä¸é€‚ç”¨äºæŸäº›åœºæ™¯ã€‚
> æ¥æ”¶ç«¯: TCPä¼šæŠŠæ¥æ”¶åˆ°çš„æ•°æ®å­˜åœ¨è‡ªå·±çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åé€šçŸ¥åº”ç”¨å±‚å–æ•°æ®ã€‚å½“åº”ç”¨å±‚ç”±äºæŸäº›åŸå› ä¸èƒ½åŠæ—¶çš„æŠŠTCPçš„æ•°æ®å–å‡ºæ¥ï¼Œå°±ä¼šé€ æˆTCPç¼“å†²åŒºä¸­å­˜æ”¾äº†å‡ æ®µæ•°æ®ã€‚

> Q: æœ‰ä½•è§£å†³åŠæ³•?
>
> ç­”: å‡ºç°â€ç²˜åŒ…â€çš„å…³é”®åœ¨äºæ¥æ”¶æ–¹ä¸ç¡®å®šå°†è¦ä¼ è¾“çš„æ•°æ®åŒ…çš„å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®åŒ…è¿›è¡Œå°åŒ…å’Œæ‹†åŒ…çš„æ“ä½œã€‚
> æ­¤æ—¶éœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ªåè®®,æ¯”å¦‚æ•°æ®åŒ…çš„å‰4ä¸ªå­—èŠ‚ä¸ºåŒ…å¤´é‡Œé¢å­˜å‚¨çš„æ˜¯å‘é€çš„æ•°æ®çš„é•¿åº¦ï¼Œç„¶åé€šè¿‡å‘é€ç«¯è¿›è¡Œå°åŒ…ã€æ¥æ”¶ç«¯è¿›è¡Œæ‹†åŒ…çš„æ“ä½œæ¥è§£å†³æ­¤é—®é¢˜ã€‚

> Q: ä»€ä¹ˆæ˜¯å°åŒ…?
>
> ç­”: å°åŒ…å°±æ˜¯ç»™ä¸€æ®µæ•°æ®åŠ ä¸ŠåŒ…å¤´ï¼Œè¿™æ ·ä¸€æ¥æ•°æ®åŒ…å°±åˆ†ä¸ºåŒ…å¤´å’ŒåŒ…ä½“ä¸¤éƒ¨åˆ†å†…å®¹äº†(è¿‡æ»¤éæ³•åŒ…æ—¶å°åŒ…ä¼šåŠ å…¥â€åŒ…å°¾â€å†…å®¹)ã€‚åŒ…å¤´éƒ¨åˆ†çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”å®ƒå­˜å‚¨äº†åŒ…ä½“çš„é•¿åº¦ï¼Œæ ¹æ®åŒ…å¤´é•¿åº¦å›ºå®šä»¥åŠåŒ…å¤´ä¸­å«æœ‰åŒ…ä½“é•¿åº¦çš„å˜é‡å°±èƒ½æ­£ç¡®çš„æ‹†åˆ†å‡ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ã€‚

å®è·µç¤ºä¾‹ï¼š

è‡ªå®šä¹‰åè®®: proto.go

```go
package proto
import (
	"bufio"
	"bytes"
	"encoding/binary"
)
// (1) Encode å°†æ¶ˆæ¯ç¼–ç 
func Encode(message string) ([]byte, error) {
	// 1.è¯»å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œè½¬æ¢æˆint32ç±»å‹ï¼ˆå 4ä¸ªå­—èŠ‚ï¼‰ä»¥åå¯ä»¥æŒ‰ç…§éœ€è¦è¿›è¡Œè‡ªå®šä¹‰
	var length = int32(len(message))
	var pkg = new(bytes.Buffer) // å‘ç³»ç»Ÿä¸ºå…·æœ‰è¯»å†™æ–¹æ³•çš„å­—èŠ‚å¤§å°å¯å˜çš„ç¼“å†²åŒºç”³è¯·å†…å­˜ã€‚
	// 2.å†™å…¥æ¶ˆæ¯å¤´
	err := binary.Write(pkg, binary.LittleEndian, length) //æ³¨æ„æ­¤å¤„ä»¥å°ç«¯çš„æ–¹å¼å†™å…¥.åœ¨åç»­è§£åŒ…æ—¶ä¹Ÿå¿…é¡»é‡‡ç”¨å°ç«¯æ–¹å¼è¯»å–
	if err != nil {
		return nil, err
	}
	// 3.å†™å…¥æ¶ˆæ¯å®ä½“
	err = binary.Write(pkg, binary.LittleEndian, []byte(message))
	if err != nil {
		return nil, err
	}
	// 4.è¿”å›å°åŒ…å®Œæ¯•çš„ç¼“å†²åŒºä¸­æ•°æ®
	return pkg.Bytes(), nil
}

// (2) Decode è§£ç æ¶ˆæ¯
func Decode(reader *bufio.Reader) (string, error) {
	// 1.è¯»å–æ¶ˆæ¯çš„é•¿åº¦
	lengthByte, _ := reader.Peek(4)           // è¯»å–å‰4ä¸ªå­—èŠ‚çš„æ•°æ®
	lengthBuff := bytes.NewBuffer(lengthByte) // NewBufferä½¿ç”¨bufä½œä¸ºåˆå§‹å†…å®¹åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªæ–°ç¼“å†²åŒº,æ­¤å¤„æŒ‡å®šè¦è¯»å–æ•°æ®çš„é•¿åº¦.
	var length int32
	err := binary.Read(lengthBuff, binary.LittleEndian, &length)
	if err != nil {
		return "", err
	}
	// 2.Bufferedè¿”å›ç¼“å†²ä¸­ç°æœ‰çš„å¯è¯»å–çš„å­—èŠ‚æ•°,å¦‚æœè·å–çš„å­—èŠ‚æ•°å°äºæ¶ˆæ¯çš„é•¿åº¦åˆ™è¯´æ˜æ•°æ®åŒ…æœ‰è¯¯.
	if int32(reader.Buffered()) < length+4 {
		return "", err
	}

	// 3.è¯»å–çœŸæ­£çš„æ¶ˆæ¯æ•°æ®
	pack := make([]byte, int(4+length))
	_, err = reader.Read(pack)
	if err != nil {
		return "", err
	}
	
	// 4.åˆ©ç”¨sliceåˆ‡ç‰‡è¿”å›å››ä¸ªå­—èŠ‚åçš„æ¶ˆæ¯æ•°æ®
	return string(pack[4:]), nil

}
```


ç„¶ååœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åˆ†åˆ«ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„protoåŒ…çš„Decode å’Œ Encodeå‡½æ•°å¤„ç†æ•°æ®ã€‚

æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
package main
import (
	"bufio"
	"fmt"
	"io"
	"net"
	"weiyigeek.top/studygo/Day08/03StickBag/proto"
)
func process(conn net.Conn) {
	// 4.é€€å‡ºæ—¶å…³é—­connèµ„æº
	defer conn.Close()
	// 5.NewReaderè¿”å›å…¶ç¼“å†²åŒºå…·æœ‰é»˜è®¤å¤§å°çš„æ–°è¯»å–å™¨ã€‚
	reader := bufio.NewReader(conn)
	for {
		// 6.è§£åŒ…: å°†é€šè¿‡connå¯¹è±¡ä¸­è·å–çš„ç¼“å†²åŒºæ•°æ®è¿›è¡Œè§£åŒ….
		msg, err := proto.Decode(reader)
		if err == io.EOF {
			return
		}
		if err != nil {
			fmt.Println("decode msg failed, err:", err)
			return
		}
		// 7.æ‰“å°è§£åŒ…åçš„æ•°æ®
		fmt.Println("æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š", msg)
	}
}
func main() {
	// 1.è®¾ç½®TCP Serverç«¯ç›‘å¬åœ°å€å’Œç«¯å£
	listen, err := net.Listen("tcp", "127.0.0.1:30000")
	if err != nil {
		fmt.Println("listen failed, err:", err)
		return
	}
	// 2.å‡½æ•°ç»“æŸåå…³é—­ç›‘å¬èµ„æº
	defer listen.Close()

	// 3.å¾ªç¯æ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ•°æ®,åˆ©ç”¨gorontineæ‰§è¡Œprocessä»»åŠ¡
	for {
		conn, err := listen.Accept()
		if err != nil {
			fmt.Println("accept failed, err:", err)
			continue
		}
		go process(conn)
	}

}
```

å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹:

```go
package main
import (
	"fmt"
	"net"
	"weiyigeek.top/studygo/Day08/03StickBag/proto"
)
func main() {
	// 1.è¿æ¥åˆ°serverç«¯.
	conn, err := net.Dial("tcp", "127.0.0.1:30000")
	if err != nil {
		fmt.Println("dial failed, err", err)
		return
	}

	// 2.ç¨‹åºç»“æŸæ—¶å…³é—­connç½‘ç»œè¿æ¥èµ„æº.
	defer conn.Close()
	
	// 3.å¾ªç¯å‘é€20æ¬¡msgç»™serverç«¯
	for i := 0; i < 20; i++ {
		msg := `Hello, Hello. How are you?`
		// 4.å°†è¦å‘é€çš„ä¿¡æ¯è¿›è¡Œå°åŒ…å¤„ç†
		data, err := proto.Encode(msg)
		if err != nil {
			fmt.Println("encode msg failed, err:", err)
			return
		}
		// 5.å°†å¤„ç†è¿‡çš„å°åŒ…è¿›è¡Œå‘é€
		conn.Write(data)
	}

}
```

æ‰§è¡Œç»“æœ: æ­¤æ—¶å‘ç°å®ƒä¸ä¼šå°†å¤šä¸ªhello...å­—ç¬¦ä¸²æ”¾åœ¨ä¸€è¡Œäº†ï¼Œå¹¶ä¸”è¾“å‡ºä¹Ÿæ˜¯æˆ‘ä»¬é¢„å®šçš„20æ¬¡ã€‚

![WeiyiGeek.é»åŒ…è§£å†³åŠæ³•](https://i0.hdslb.com/bfs/article/584083aa59ce90a7599c34f088c212e87bc66bf2.png@942w_563h_progressive.png)


è¡¥å……çŸ¥è¯†:å­—èŠ‚åºåˆ—çš„å­˜å‚¨æ ¼å¼ä¹‹å¤§ç«¯(Big-endian)å’Œå°ç«¯(LittleEndian)å­˜å‚¨

â€‹	Big-endianï¼šå°†é«˜åºå­—èŠ‚å­˜å‚¨åœ¨èµ·å§‹åœ°å€ï¼ˆé«˜ä½ç¼–å€ï¼‰ï¼Œæ­¤ç§æ–¹å¼ä¾¿äºäººç±»ç†è§£ã€‚
â€‹	Little-endianï¼šå°†ä½åºå­—èŠ‚å­˜å‚¨åœ¨èµ·å§‹åœ°å€ï¼ˆä½ä½ç¼–å€ï¼‰ä¸€èˆ¬åœ¨x64/x32çš„ç³»ç»Ÿä¸­éƒ½æ˜¯å°ç«¯å­˜å‚¨ã€‚
ä¸¾ä¸ªä¾‹å­: å¦‚æœæˆ‘ä»¬å°†0x1234abcdå†™å…¥åˆ°ä»¥0x0000å¼€å§‹çš„å†…å­˜ä¸­ï¼Œåˆ™ç»“æœä¸ºï¼›


æ³¨ï¼šæ¯ä¸ªåœ°å€å­˜1ä¸ªå­—èŠ‚ï¼Œ2ä½16è¿›åˆ¶æ•°æ˜¯1ä¸ªå­—èŠ‚ï¼ˆ0xFF=11111111ï¼‰ï¼›

![WeiyiGeek.å¤§ç«¯å’Œå°ç«¯](https://i0.hdslb.com/bfs/article/45399474323d5b8a2136a3818b701d87a12db84e.png@942w_495h_progressive.png)


è¡¥å……çŸ¥è¯†:CPUå­˜å‚¨ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶å…¶å­—èŠ‚å†…çš„8ä¸ªæ¯”ç‰¹ä¹‹é—´çš„é¡ºåºæ˜¯å¦ä¹Ÿæœ‰big endianå’Œlittle endianä¹‹åˆ†ï¼Ÿæˆ–è€…è¯´æ˜¯å¦æœ‰æ¯”ç‰¹åºçš„ä¸åŒï¼Ÿ

å®é™…ä¸Šï¼Œè¿™ä¸ªæ¯”ç‰¹åºæ˜¯åŒæ ·å­˜åœ¨çš„åªæ˜¯å¤šä¸ªä¸¤ä¸ªè¡¨ç¤ºåç§°ï¼ˆMSB å’Œ LSBï¼‰ã€‚
MSBçš„æ„æ€æ˜¯ï¼šå…¨ç§°ä¸ºMost Significant Bitï¼Œåœ¨äºŒè¿›åˆ¶æ•°ä¸­å±äºæœ€é«˜æœ‰æ•ˆä½ï¼ŒMSBæ˜¯æœ€é«˜åŠ æƒä½ï¼Œä¸åè¿›åˆ¶æ•°å­—ä¸­æœ€å·¦è¾¹çš„ä¸€ä½ç±»ä¼¼ã€‚
LSBçš„æ„æ€æ˜¯ï¼šå…¨ç§°ä¸ºLeast Significant Bitï¼Œåœ¨äºŒè¿›åˆ¶æ•°ä¸­æ„ä¸ºæœ€ä½æœ‰æ•ˆä½ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒMSBä½äºäºŒè¿›åˆ¶æ•°çš„æœ€å·¦ä¾§ï¼ŒLSBä½äºäºŒè¿›åˆ¶æ•°çš„æœ€å³ä¾§ã€‚

ä¸‹é¢ä»¥æ•°å­—0xB4ï¼ˆ10110100ï¼‰ç”¨å›¾åŠ ä»¥è¯´æ˜ã€‚

```sh
# Big Endian

msb------------------------>lsb
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   1  |   0  |   1  |   1  |   0  |   1  |   0  |   0  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


# Little Endian

lsb-------------------------->msb
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|   0  |   0  |   1  |   0  |   1  |   1  |   0  |   1  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

å®é™…ä¸Šï¼Œç”±äºCPUå­˜å‚¨æ•°æ®æ“ä½œçš„æœ€å°å•ä½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œå…¶å†…éƒ¨çš„æ¯”ç‰¹åºæ˜¯ä»€ä¹ˆæ ·å¯¹æˆ‘ä»¬çš„ç¨‹åºæ¥è¯´æ˜¯ä¸€ä¸ªé»‘ç›’å­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ç»™æˆ‘ä¸€ä¸ªæŒ‡å‘0xB4è¿™ä¸ªæ•°çš„æŒ‡é’ˆï¼Œå¯¹äºbig endianæ–¹å¼çš„CPUæ¥è¯´ï¼Œå®ƒæ˜¯ä»å·¦å¾€å³ä¾æ¬¡è¯»å–è¿™ä¸ªæ•°çš„8ä¸ªæ¯”ç‰¹ï¼›è€Œå¯¹äºlittle endianæ–¹å¼çš„CPUæ¥è¯´ï¼Œåˆ™æ­£å¥½ç›¸åï¼Œæ˜¯ä»å³å¾€å·¦ä¾æ¬¡è¯»å–è¿™ä¸ªæ•°çš„8ä¸ªæ¯”ç‰¹ã€‚è€Œæˆ‘ä»¬çš„ç¨‹åºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆè®¿é—®åå¾—åˆ°çš„æ•°å°±æ˜¯0xB4ï¼Œå­—èŠ‚å†…éƒ¨çš„æ¯”ç‰¹åºå¯¹äºç¨‹åºæ¥è¯´æ˜¯ä¸å¯è§çš„ï¼Œå…¶å®è¿™ç‚¹å¯¹äºå•æœºä¸Šçš„å­—èŠ‚åºæ¥è¯´ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

è‡³æ­¤ï¼ŒGoè¯­è¨€ä¸­Socketç½‘ç»œç¼–ç¨‹å­¦ä¹ å®Œæ¯•ï¼